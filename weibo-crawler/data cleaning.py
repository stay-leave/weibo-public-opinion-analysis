#coding='utf-8'
import xlrd
import re
import xlwt
import os
from multiprocessing.dummy import Pool as ThreadPool

def stoplist():
    with open('åœç”¨è¯è¡¨.txt','r',encoding='utf-8')as f:
        stops=f.readlines()
    return stops


def extract(inpath,l):
    """å–å‡ºä¸€åˆ—æ•°æ®"""
    data = xlrd.open_workbook(inpath, encoding_override='utf-8')
    table = data.sheets()[0]#é€‰å®šè¡¨
    nrows = table.nrows#è·å–è¡Œå·
    ncols = table.ncols#è·å–åˆ—å·
    numbers=[]
    for i in range(1, nrows):#ç¬¬0è¡Œä¸ºè¡¨å¤´
        alldata = table.row_values(i)#å¾ªç¯è¾“å‡ºexcelè¡¨ä¸­æ¯ä¸€è¡Œï¼Œå³æ‰€æœ‰æ•°æ®
        result = alldata[l]#å–å‡ºè¡¨ä¸­ç¬¬ä¸€åˆ—æ•°æ®
        numbers.append(result)
    return numbers

def clean(line):
    """å¯¹ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®è¿›è¡Œæ¸…æ´—"""
    URL_REGEX = re.compile(r'(?i)\b((?:https?://|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:\'".,<>?Â«Â»â€œâ€â€˜â€™]))',re.IGNORECASE)
    n_alls=[]
    pattern_0=re.compile('#.*?#')#åœ¨ç”¨æˆ·åå¤„åŒ¹é…è¯é¢˜åç§°
    pattern_1=re.compile('<a.*?</a>')#åœ¨å†…å®¹å¤„åŒ¹é…å›¾ç‰‡åœ°å€
    pattern_2=re.compile("(@.*? )+|(@.*)")#åŒ¹é…é¦–å°¾æ ‡ç‚¹ç¬¦å·
    pattern_3=re.compile('\d+')#åŒ¹é…çº¯æ•°å­—
    pattern_4=re.compile(u'[\U00010000-\U0010ffff\uD800-\uDBFF\uDC00-\uDFFF]')#åŒ¹é…è¡¨æƒ…
    pattern_5=re.compile('(.*?)')#åŒ¹é…ä¸€éƒ¨åˆ†é¢œæ–‡å­—
    pattern_6=re.compile(u'[\u4e00-\u9fa5]+')#åŒ¹é…ä¸­æ–‡
    try:#æ²¡æœ‰åŒ¹é…åˆ°çš„æƒ…å†µè§£å†³
        h_0=re.search(pattern_0,line[1]).group()
    except:
        h_0=' '
    try:
        h_1=re.search(pattern_1,line[2]).group()
    except:
        h_1=' '
    try:
        h_2=re.search(pattern_2,line[2]).group()#è½¬æ¢ä¸ºstr
    except:
        h_2=' '
    try:
        h_3=re.search(pattern_3,line[2]).group()
    except:
        h_3='å ä½ç¬¦'
    line[1]=line[1].replace(h_0,'')
    line[1]=line[1].replace('è¶…è¯ç¤¾åŒº','')#å»é™¤æ— æ„ä¹‰åç§°
    line[2]=line[2].replace(h_1,'')
    line[2]=line[2].replace(h_2,'')#æ¸…é™¤æ— ç”¨å­—ç¬¦
    rep=['å›å¤:','å›å¤çš„è¡¨æ€','å›¾ç‰‡è¯„è®º ','å›¾ç‰‡è¯„è®º','//:  ','ã€ã€‘','ã€','ã€‘','è½¬å‘å¾®åš','ä¸‹åˆå¥½','ä¸‹åˆå¥½','ğŸ‘','ğŸ¤','ã€‚ã€‚','å¤–äº¤éƒ¨ï¼š','ä¿¡æ¯å‘å¸ƒå¾®å¹³å°',
         'æ‰©æ•£','ä¿¡æ¯å‘å¸ƒçš„å¾®å¹³å°','ğŸ®','ğŸ™','ğŸ‡¨ğŸ‡³','ğŸ‘','â¤ï¸','â€¦â€¦â€¦','ä¿¡æ¯ä¼ æ’­å¾®å¹³å°','ğŸ°','...ã€ã€','ï¼Œï¼Œ','..','ğŸ’ª','ğŸ¤“','æ™šå®‰å‰ç¥¥ï¼',
         'æ¥äº’åŠ¨å–½','æ¥çœ‹çœ‹å“¦','æ”¶è—äº†','çœ‹ä¸€ä¸‹ã€‚','ç‚¹ä¸ªèµ','æ¥çœ‹çœ‹å“¦','æˆ‘æ¥çœ‹çœ‹ä½ ','å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šï¼','å˜¿å˜¿å˜¿å˜¿å˜¿ã€å˜¿','åˆ’é‡ç‚¹ï¼åˆ’é‡ç‚¹ï¼',
         'å¤©å•¦å™œ','âš•ï¸','ğŸ‘©','è½¬å‘','ğŸ™ƒ','ğŸ˜‡','ğŸº','ğŸ‚','ğŸ™ŒğŸ»','ğŸ˜‚','ğŸ“–','ğŸ˜­','èµèµ','âœ§Ù©(ËŠÏ‰Ë‹*)Ùˆâœ§','ğŸ¦','ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ','//','ğŸ˜Š','ğŸ’°','ğŸ˜œ','ğŸ˜¯',
         '(áƒ¦Ë˜âŒ£Ë˜áƒ¦)','âœ§ï¼¼Ù©(ëˆˆà±ªëˆˆ)Ùˆ/ï¼âœ§','ä¼ é€’ä¿¡æ¯å¾®å¹³å°','ğŸŒ','ä¼ é€’æ–°é—»èµ„è®¯~','ğŸ€','ä¼ é€’æœ‰ç”¨çš„ä¿¡æ¯','ï¼Ÿï¼Ÿ','ğŸ´','æ‰©æ•£å‘¨çŸ¥','è½¬ï¼',
         'è½¬å‘å‘¨çŸ¥','ğŸŒ»','ğŸŒ±','ğŸŒ±','ğŸŒ»','æ”¶è—è½¬å‘ï½ï½ï½','ğŸ™ˆ','ä¼˜è´¨å†…å®¹','ä¿¡æ¯å‘å¸ƒå¾®å¹³å°ï¼ï¼ï¼','(à¸‡â€¢Ì€_â€¢Ì)à¸‡ï¼','ğŸ‰‘ï¸','ç›´æ’­ï¼','ğŸ’©','ä¿¡æ¯å‘å¸ƒå¾®å¹³å°ï¼',
         'ğŸ','âŠ™âˆ€âŠ™ï¼','ğŸ™Š','ã€ï¼Ÿ','+1','è²æ€»ç»Ÿåºœï¼š','ğŸ˜„','ğŸ™','æ—©å®‰','åˆå®‰','æ™šå®‰','ä½ æƒ³çŸ¥é“çš„éƒ½åœ¨è¿™ï¼','ğŸ‘‡ğŸ»','ğŸ“š','ğŸ™‡','æ”¶è—','ã€ã€Šé¢å¯¹é¢ã€‹æ­£åœ¨æ’­å‡ºï¼šï¼ã€‘',
         'ğŸ™‹','åº·åº·','æ·±å¤œå¥½','å ä¸ªä½ç½®','ï¼ï¼ï¼ï¼','ğŸ‰','ï¼¼(^â–½^)ï¼','ğŸ‘Œ','æ™šä¸Šå¥½','ã€æœ€å…¨è§£ç­”ï¼ã€‘','ğŸ†’','ğŸ»','ä¸Šåˆå¥½','ä¸‹åˆå¥½','æ™šä¸Šå¥½','æ·±å¤œå¥½',
         'ğŸ™‰','ğŸµ','ğŸˆ','ğŸŠ','0371-12345','â˜•ï¸','ğŸŒ','ğŸ˜³','ğŸ‘»','ğŸ¶','ğŸ‘„','\U0001f92e\U0001f92e','ğŸ˜”','ï¼‹1','ğŸ›€','ğŸ¸','ğŸ·','æ–°é—»1ã€‹|ï¼Ÿ','â•1',
         'ğŸŒš','ï¼šï¼š','ğŸ’‰','âˆš','x','ï¼ï¼ï¼','ğŸ™…','â™‚ï¸','ğŸ’Š','ğŸ‘‹','o(^o^)o','mei\u2006sha\u2006shi','ğŸ’‰','ğŸ˜ª','æ—©ä¸Šå¥½','ğŸ˜±','å¤šäº’åŠ¨','\U0001f9a0',
         'ğŸ¤—','å…³æ³¨','â€¦â€¦','(((â•¹Ğ´â•¹;)))','âš ï¸','Ô¾â€¸Ô¾','â›½ï¸','ğŸ˜“','ğŸµ','äº†è§£','å…³æ³¨çƒ­ç‚¹ï¼Œä¼ é€’æ­£èƒ½é‡','ä¼ æ’­æ³•æ²»æ­£èƒ½é‡','ä¼ æ’­æ³•æ²»æ­£èƒ½é‡~ï¼',
         'ä¼ é€’æ³•æ²»åŠ›é‡','ä¼ æ’­æ³•æ²»æ­£èƒ½é‡ä¼ æ’­æ³•æ²»æ­£èƒ½é‡','ä¿¡æ¯å‘å¸ƒå¾®å¹³','ğŸ™„ï¸','å·²ç»','8âƒ£ï¸','æ¥ä¸²é—¨','äº’åŠ¨æ¥å•¦','å¼ºè€…ä¸å¼±è€…çš„åˆ†ç•Œå°±åœ¨äºè°æ›´æ„¿æ„è¯„è®ºå’Œç‚¹èµ',
         'ğŸŒ•','æ–°å† ç–«è‹—æœ€å¿«ä½•æ—¶ä¸Šå¸‚ï¼Ÿ8ä¸ªæœ€æ–°æƒå¨é—®ç­”æ¥äº†ï¼','â€¦','ğŸ˜‹','[]','[',']','â†’_â†’','ğŸ’','ğŸ˜¨','&quot;','ğŸ˜','à¸…Û¶â€¢ï»Œâ€¢â™¡','ğŸ˜°','ğŸ™ï¸',
         'ğŸ¤§','ğŸ˜«','(à¸‡â€¢Ì€_â€¢Ì)à¸‡','ğŸ˜','âœŠ','ğŸš¬','ğŸ˜¤','ğŸ‘»','ğŸ˜£','ï¼š','ğŸ˜·','(*^â–½^)/â˜…*â˜†','ğŸ','ğŸ”','ğŸ˜˜','ğŸ‹','(âœªâ–½âœª)','è½¬æ”¶','é©¬äº†','(âÂ´Ï‰`â)','1âƒ£3âƒ£','(^_^)ï¼','â˜€ï¸',
	 'ğŸ','ğŸ˜…','ğŸŒ¹','ğŸ ','â†’_â†’','ğŸ™‚','âœ¨','â„ï¸','â€¢','ğŸŒ¤','ğŸ’“','ğŸ”¨','å›å¤çš„è¡¨æ€','ğŸ‘','çš„è¡¨æ€','è¶£å›¾è¯„è®º','è½¬å‘','ğŸ˜','âŠ™âˆ€âŠ™ï¼','ğŸ‘','âœŒ(Ì¿â–€Ì¿\u2009Ì¿Ä¹Ì¯Ì¿Ì¿â–€Ì¿Ì¿)âœŒ',
         'ğŸ˜Š','ğŸ‘†','ğŸ’¤','ğŸ˜˜','ğŸ˜Š','ğŸ˜´','ğŸ˜‰','ğŸŒŸ','â™¡â™ª..ğ™œğ™¤ğ™¤ğ™™ğ™£ğ™ğ™œğ™ğ™©â€¢Íˆá´—â€¢Íˆâœ©â€§â‚ŠËš','ğŸ‘ª','ğŸ’°','ğŸ˜','ğŸ€','ğŸ›','ğŸ–•ğŸ¼','ğŸ˜‚','(âœªâ–½âœª)','ğŸ‹','ğŸ…','ğŸ‘€','â™‚ï¸','ğŸ™‹ğŸ»','âœŒï¸','ğŸ¥³','ï¿£ï¿£)Ïƒ',
         'ğŸ˜’','ğŸ˜‰','ğŸ¦€','ğŸ’–','âœŠ','ğŸ’ª','å…³æ³¨çƒ­ç‚¹ï¼Œä¼ é€’æ­£èƒ½é‡','ğŸ™„','ğŸ£','ğŸŒ¾','âœ”ï¸','è¸©è¸©','æ¬¢è¿äº’åŠ¨','æ„Ÿè°¢åˆ†äº«ï¼Œæ¬¢è¿å›è®¿','ğŸ˜¡','ğŸ˜Œ','ğŸ”¥','â¤',
         'ğŸ¼','çƒ­ç‚¹','çƒ­ç‚¹ï¼Œä¼ é€’æ³•æ²»èµ„è®¯','æ‰©è½¬å‘¨çŸ¥','ğŸ¤­','è°¢è°¢','çƒ­ç‚¹ï¼Œä¼ é€’æ­£èƒ½é‡','ç«‹è¶³æ£€å¯ŸèŒèƒ½ä»¥æ£€å¯Ÿè§†è§’å„ç•ŒåŠ¨æ€','å‘å¸ƒçš„ä¿¡æ¯',
         'ğŸŒ¿','ä¸¨','âœ…','ğŸ¥','ï¾‰','â˜€','5âƒ£âº1âƒ£0âƒ£','te\u2006s\u2006t','ä¸–å«ç»„ç»‡å›½è¯ç–«è‹—æ˜“å‚¨å­˜ï¼Œ','æ³•æ²»ing','ğŸš£','ğŸ£','ğŸ¤¯','ğŸŒº','å‘¨ä¸‰å¿«ä¹ï¼',
         'æ€¥è½¬','ğŸŒ¸','å‘¨çŸ¥','åˆé¤å¿«ä¹ï¼','æ¨è!','åŠ v','åšä¸»v','è®¾ç½®é—¹é’Ÿï¼Œæ¯å¤©åªéœ€30ç§’ç‚¹äº®é—ªç”µï¼Œçœ‹æ•™ç¨‹ä¸‹è½½æ³¨å†Œï¼Œæœ‰ä¸æ‡‚çš„å¾®åšç§ä¿¡æˆ‘',
         'æ³¨å†ŒæŒ–çŸ¿','åˆ°æ—¶å–æˆ‘','å¤§å†™ï¼‹å°å†™ï¼‹æ•°å­¦','å·²åŠ ','æ¥äº†','è½¬æ‰©','è”¡å¾å¤','ï¼ï¼','åŒé—®','å”‰ã€‚','ä¼ æ’­æ­£èƒ½é‡','ï¼Œä¼ æ’­æ­£èƒ½é‡'

         ]
    #å¤ªå¤šæ— ç”¨å­—ç¬¦ï¼Œæ‡’å¾—æ·»åŠ åœ¨åœç”¨è¯è¡¨äº†
    if line[1].isspace()==False:#ç”¨æˆ·åä¸ä¸ºç©º
        for i in rep:
            line[2]=line[2].replace(i,'')
        line[2]=re.sub(pattern_1, '', line[2]) #å»é™¤é“¾æ¥æ–‡å­—æ··åˆä¸­çš„é“¾æ¥
        line[2]=re.sub(pattern_2, '', line[2]) #å»é™¤é¦–å°¾æ ‡ç‚¹
        line[2]=re.sub(pattern_4, '', line[2]) #å»é™¤è¡¨æƒ…
        line[2]=re.sub(pattern_5, '', line[2]) #å»é™¤ä¸€éƒ¨åˆ†é¢œæ–‡å­—
        line[2]=re.sub(r'\[\S+\]', '', line[2]) #å»é™¤è¡¨æƒ…ç¬¦å·
        line[2]= re.sub(URL_REGEX,'', line[2])# å»é™¤ç½‘å€
        line[2]=line[2].replace('ğŸˆ·ï¸','æœˆ')#æ–‡å­—è½¬æ¢
        line[2]=line[2].replace('ğŸˆš','æ— ')
        line[2]=line[2].replace('ğŸ‰ï¸','å¾—')
        line[2]=line[2].replace('ğŸˆ¶','æœ‰')
        line[2]=line[2].replace('9âƒ£ï¸å‘½','æ•‘å‘½')
        line[2]=line[2].replace('â“','ï¼Ÿ')
        line[2]=line[2].replace('ğŸµ','èŒ¶')
        line[2]=line[2].replace('â•','åŠ ')
        line[2]=line[2].replace('â›°ï¸','å±±')
        match_0=pattern_6.search(line[2])#åˆ¤æ–­æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
        if line[2].isspace()==False:#å†…å®¹ä¸ä¸ºç©º
            for i in stoplist():
                if line[2]!=i:#å»åœç”¨è¯
                    if line[2]!='':#ä¸ä¸ºç©º
                        if len(line[2])>=20:#æ¸…é™¤å•å­—
                            if line[2]!=h_3:#è¯¥å­—ç¬¦ä¸²ä¸æ˜¯çº¯æ•°å­—
                                if line[2].isalpha()==False:#ä¸æ˜¯çº¯è‹±æ–‡
                                    if match_0:
                                        if line not in n_alls:#å»é‡
                                            n_alls.append(line)
    return n_alls



def file(inpath):
    """æå–ä¸€ä¸ªæ–‡ä»¶ä¸ºä¸€ä¸ªå¤§åˆ—è¡¨"""
    data = xlrd.open_workbook(inpath, encoding_override='utf-8')
    table = data.sheets()[0]#é€‰å®šè¡¨
    nrows = table.nrows#è·å–è¡Œå·
    ncols = table.ncols#è·å–åˆ—å·
    numbers=[]
    for i in range(1, nrows):#ç¬¬0è¡Œä¸ºè¡¨å¤´
        alldata = table.row_values(i)#å¾ªç¯è¾“å‡ºexcelè¡¨ä¸­æ¯ä¸€è¡Œï¼Œå³æ‰€æœ‰æ•°æ®
        numbers.append(alldata)
    return numbers

def save_afile(alls,filename):
    """å°†ä¸€ä¸ªåŸºé‡‘çš„è®ºæ–‡æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªexcel"""
    f=xlwt.Workbook()
    sheet1=f.add_sheet(u'sheet1',cell_overwrite_ok=True)
    sheet1.write(0,0,'ç”¨æˆ·ID')
    sheet1.write(0,1,'ç”¨æˆ·å')
    sheet1.write(0,2,'è¯„è®ºå†…å®¹')
    sheet1.write(0,3,'æ—¶é—´')
    i=1
    for data in alls:#éå†æ¯ä¸€è¡Œ
        for j in range(len(data)):#å–ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ¯ä¸€å•å…ƒæ ¼
            sheet1.write(i,j,data[j])#å†™å…¥å•å…ƒæ ¼
        i=i+1#å¾€ä¸‹ä¸€è¡Œ
    f.save(filename)

if __name__ == '__main__':
    filenames=os.listdir(r'è¯„è®º_xlsx')#æ–‡ä»¶å
    for j in filenames:
        items=file(r'è¯„è®º_xlsx\\'+j)
        #print(items)
        pool = ThreadPool()
        alls=pool.map(clean, items)#å¤šçº¿ç¨‹å’Œæ™®é€šçš„åˆ—è¡¨åµŒå¥—ä¸ä¸€æ ·ï¼Œæ˜¯ç›´æ¥å°†åˆ—è¡¨é‡Œé¢çš„å…ƒç´ å–å‡ºæ¥äº†ã€‚è€Œä¸”è¾“å‡ºæ˜¯äºŒæ¬¡åµŒå¥—åˆ—è¡¨
        pool.close()
        pool.join()
        #print(alls)
        #å»é™¤ç©ºåˆ—è¡¨ï¼Œå°†åµŒå¥—åˆ—è¡¨å–å‡º
        alls_1=[]
        n=[]
        for i in alls:
            if i!=n:
                alls_1.append(i[0])
        save_afile(alls_1,'æ¸…æ´—è¯„è®º//'+j)
    